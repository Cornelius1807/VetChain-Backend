generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  dueno
  veterinario
  admin
}

enum EstadoCuenta {
  active
  inactive
  pending
  rejected
}

enum EstadoCita {
  Programada
  Confirmada
  Atendida
  Cancelada
  Rechazada
}

enum EstadoSlot {
  LIBRE
  RESERVADO
  BLOQUEADO
  FUERA_RANGO
}

model Cuenta {
  id           String       @id @default(uuid())
  correo       String       @unique
  hash         String
  rol          Rol
  estado       EstadoCuenta @default(pending)
  creadoEn     DateTime     @default(now())
  confirmadoEn DateTime?
  eliminadoEn  DateTime?

  dueno       Dueno?
  veterinario Veterinario?

  resetTokens    PasswordResetToken[]
  emailTokens    EmailConfirmationToken[]
  deleteReqs     DeleteRequest[]
  notificaciones Notificacion[]
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  cuentaId  String
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  cuenta    Cuenta    @relation(fields: [cuentaId], references: [id])
}

model EmailConfirmationToken {
  id        String    @id @default(uuid())
  token     String    @unique
  cuentaId  String
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  cuenta    Cuenta    @relation(fields: [cuentaId], references: [id])
}

model DeleteRequest {
  id         String    @id @default(uuid())
  cuentaId   String
  motivo     String?
  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  rejectedAt DateTime?
  cuenta     Cuenta    @relation(fields: [cuentaId], references: [id])
}

model Dueno {
  id        String  @id @default(uuid())
  cuentaId  String  @unique
  dni       String  @unique
  nombres   String
  apellidos String
  telefono  String
  direccion String?

  cuenta   Cuenta    @relation(fields: [cuentaId], references: [id])
  mascotas Mascota[]
  citas    Cita[]
}

model Veterinario {
  id               String  @id @default(uuid())
  cuentaId         String  @unique
  dni              String  @unique
  nombre           String
  apellidos        String?
  telefono         String?
  especialidad     String
  centroId         String?
  tituloURL        String?
  constanciaURL    String?
  puedeCrearCentro Boolean @default(false)

  cuenta         Cuenta              @relation(fields: [cuentaId], references: [id])
  centro         CentroVeterinario?  @relation("CentroAsignado", fields: [centroId], references: [id])
  programaciones Programacion[]
  slots          HorarioSlot[]
  citas          Cita[]
  centrosCreados CentroVeterinario[] @relation("CentroCreador")
}

model CentroVeterinario {
  id                  String  @id @default(uuid())
  nombre              String
  direccion           String
  telefono            String?
  email               String?
  rangoAtencionInicio String?
  rangoAtencionFin    String?
  rangoConsultaInicio String?
  rangoConsultaFin    String?
  creadoPorVetId      String?

  creadoPor    Veterinario?  @relation("CentroCreador", fields: [creadoPorVetId], references: [id])
  consultorios Consultorio[]
  veterinarios Veterinario[] @relation("CentroAsignado")
  citas        Cita[]
  slots        HorarioSlot[]
}

model Consultorio {
  id       String @id @default(uuid())
  centroId String
  nombre   String

  centro CentroVeterinario @relation(fields: [centroId], references: [id])
  slots  HorarioSlot[]
  citas  Cita[]
}

model Programacion {
  id            String   @id @default(uuid())
  veterinarioId String
  fechaInicio   DateTime
  fechaFin      DateTime
  creadoEn      DateTime @default(now())

  veterinario Veterinario   @relation(fields: [veterinarioId], references: [id])
  slots       HorarioSlot[]
}

model HorarioSlot {
  id             String     @id @default(uuid())
  veterinarioId  String
  centroId       String?
  consultorioId  String?
  programacionId String?
  fechaInicio    DateTime
  fechaFin       DateTime
  estado         EstadoSlot @default(LIBRE)
  motivo         String?

  veterinario  Veterinario        @relation(fields: [veterinarioId], references: [id])
  centro       CentroVeterinario? @relation(fields: [centroId], references: [id])
  consultorio  Consultorio?       @relation(fields: [consultorioId], references: [id])
  programacion Programacion?      @relation(fields: [programacionId], references: [id])
  Cita         Cita?
}

model Mascota {
  id          String  @id @default(uuid())
  duenoId     String
  nombre      String
  especie     String
  raza        String
  genero      String
  edad        Int
  peso        Float?
  imagenURL   String?
  descripcion String?
  activa      Boolean @default(true)

  dueno     Dueno             @relation(fields: [duenoId], references: [id])
  historial HistorialClinico?
  resumen   ResumenMedico?    @relation("MascotaResumen")
  citas     Cita[]

  @@unique([duenoId, nombre, especie, edad])
}

model HistorialClinico {
  id        String  @id @default(uuid())
  mascotaId String  @unique
  mascota   Mascota @relation(fields: [mascotaId], references: [id])
  entradas  Cita[]  @relation("HistorialCitas")
}

model ResumenMedico {
  id          String   @id @default(uuid())
  mascotaId   String   @unique
  resumen     String?
  actualizado DateTime @default(now())

  mascota Mascota @relation("MascotaResumen", fields: [mascotaId], references: [id])
}

model Cita {
  id                String     @id @default(uuid())
  motivo            String
  fecha             DateTime
  estado            EstadoCita @default(Programada)
  creadoEn          DateTime   @default(now())
  motivoCancelacion String?

  centroId String
  centro   CentroVeterinario @relation(fields: [centroId], references: [id])

  consultorioId String?
  consultorio   Consultorio? @relation(fields: [consultorioId], references: [id])

  veterinarioId String
  veterinario   Veterinario @relation(fields: [veterinarioId], references: [id])

  duenoId String
  dueno   Dueno  @relation(fields: [duenoId], references: [id])

  mascotaId String
  mascota   Mascota @relation(fields: [mascotaId], references: [id])

  slotId String?      @unique
  slot   HorarioSlot? @relation(fields: [slotId], references: [id])

  hallazgos   String?
  pruebas     String?
  tratamiento String?

  historialId String?
  historial   HistorialClinico? @relation("HistorialCitas", fields: [historialId], references: [id])

  notificaciones Notificacion[]
}

model Notificacion {
  id            String    @id @default(uuid())
  cuentaId      String?
  correoDestino String
  tipo          String
  payload       Json
  estado        String    @default("pendiente")
  createdAt     DateTime  @default(now())
  enviadoAt     DateTime?
  citaId        String?

  cuenta Cuenta? @relation(fields: [cuentaId], references: [id])
  cita   Cita?   @relation(fields: [citaId], references: [id])
}
